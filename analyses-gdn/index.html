<!DOCTYPE html>
<meta charset="utf-8">
<body>
  
  
  
<h1 class="theme_1" style="text-align: center; font-family: 'Montserrat', sans-serif;"> Analyse des données du Grand Débat National </h1>
<h4 style="margin-top:-20px; font-style: italic; color:white; font-weight:100; margin-left:21%;"> Projet lauréat du Hackaton "Données du Grand Débat", organisé à l'Assemblée Nationale le 23 mars 2019</h4>

	<div style="margin: 0 auto; width:100px; height:00px;">
	  <p>
	          Nous vous proposons
	          
	          
	  </p>

	</div>
	<div style="margin: 0 auto; width:100px; height:00px;">
	  		<img alt="" class="separator" src="https://granddebat.fr/media/default/0001/01/a18fa132d2853aa1636bbd61ccc017bc97f02187.png" height="2px" 	style="margin-top: 60px;">	  	
	</div>

<h3 id="h_part" class="theme_d" style="border-radius: 2% / 2%; background: url('https://granddebat.fr/media/default/0001/01/cc552f70006a6e8afcc3b7f6a5d3923928ae4ec5.png') center center no-repeat;">Profil des contributeurs</h3>


<div id="main_chart_q_part" class="main">
<div class="row_white">
		<div style="text-align: center;"></div> <!-- Empty to center the next one -->
		<div>
			
					<div>
						<label>Données</label>
						<select id="select_resp_part">
						</select>
					</div>
			
		</div>
	</div>
		<div style="background-color: #fff; padding-bottom:150px; padding-top:20px; ">

  <div id="chart_q_part" class="chart"></div>
  <div id="map_chart_part" class="map"></div>
</div>
</div>
<div id="map"></div>

<div style="margin: 0 auto; width:100px; height:100px; background-color:#fff">
	  		<img alt="" class="separator" src="https://granddebat.fr/media/default/0001/01/a18fa132d2853aa1636bbd61ccc017bc97f02187.png" height="2px" 	style="margin-top: 60px;">
</div>

<h3 id="h_ecolo" class="theme_d" style="background: url('https://granddebat.fr/media/default/0001/01/f1a9b39892624d797aee67e9bd2918147dd54271.png') center center no-repeat;">La transition écologique</h3>


<!--
<h3 id="h_ecolo" style="text-align: center; font-family: 'Montserrat', sans-serif; padding-top:50px;">La transition écologique</h3>
-->
<div class="row_white">
		<div style="text-align: center;"></div> <!-- Empty to center the next one -->
		<div>

					<div>
						<label>Questions</label>
						<select id="select_chart_ecolo"></select>
					</div>

		</div>
	</div>
<div id="main_chart_ecolo" class="main_q">
	<div id="chart_ecolo" class="chart_m"></div>
</div>
<div id="main_chart_q_ecolo" class="main">
	<div class="row_white">
	  <div style="text-align: center;"></div> 
	   <div>
						<label >Réponses</label>
						<select id="select_resp_ecolo"></select>
							</div>
		</div>

		<div style="background-color: #fff; padding-bottom:150px; padding-top:20px;">
	 	<div id="chart_q_ecolo" class="chart" ></div>
	  <div id="map_chart_ecolo" class="map" ></div> 
	</div>
</div>
	<div style="margin: 0 auto; width:100px; height:100px;">
	  		<img alt="" class="separator" src="https://granddebat.fr/media/default/0001/01/a18fa132d2853aa1636bbd61ccc017bc97f02187.png" height="2px" 	style="margin-top: 60px;">	</div>


<h3 id="h_fisc" class="theme_d"  style="background: url('https://granddebat.fr/media/default/0001/01/1b7acecba51dbed3d1b999edd4295c0fdb6d648e.png') center center no-repeat;">La fiscalité et les dépenses publics</h3>
<div class="row_white">
		<div style="text-align: center;"></div> <!-- Empty to center the next one -->
		<div>
			
	
					<div>
						<label>Questions</label>
						<select id="select_chart_fisc"></select>
					</div>
	
			
		</div>
	</div>
<div id="main_chart_fisc" class="main_q">
	<div id="chart_fisc" class="chart_m"></div>
</div>
<div id="main_chart_q_fisc" class="main">
	<div class="row_white">
	  <div style="text-align: center;"></div> 
	  <div>
	    		<label >Réponses</label>
						<select id="select_resp_fisc"></select>
	  </div>
	  
				
		</div>

<div style="background-color: #fff; padding-bottom:150px;  padding-top:20px;">
	  <div id="chart_q_fisc" class="chart"></div>
	  <div id="map_chart_fisc" class="map"></div>
	</div>
</div>
	<div style="margin: 0 auto; width:100px; height:100px;">
	  		<img alt="" class="separator" src="https://granddebat.fr/media/default/0001/01/a18fa132d2853aa1636bbd61ccc017bc97f02187.png" height="2px" 	style="margin-top: 60px;">	</div>
	

<h3 id="h_cit" class="theme_d"  style="background: url('https://granddebat.fr/media/default/0001/01/b8234f561ccf9f244a406f028c98174403f4dfc0.png') center center no-repeat;">Démocratie et Citoyenneté</h3>
<div class="row_white">
		<div style="text-align: center;"></div> <!-- Empty to center the next one -->
		<div>
			
	
					<div>
						<label>Questions</label>
						<select id="select_chart_cit"></select>
					</div>
	
			
		</div>
	</div>
<div id="main_chart_cit" class="main_q">
	<div id="chart_cit" class="chart_m"></div>
</div>
<div id="main_chart_q_cit" class="main">
	<div class="row_white">
	  <div style="text-align: center;"></div>
	  <div>
						<label >Réponses</label>
						<select id="select_resp_cit"></select>
						</div>
		</div>

		<div style="background-color: #fff; padding-bottom:150px;  padding-top:20px;">
	  <div id="chart_q_cit" class="chart"></div>
	  <div id="map_chart_cit" class="map"></div>
	</div>
</div>
	<div style="margin: 0 auto; width:100px; height:100px;">
	  		<img alt="" class="separator" src="https://granddebat.fr/media/default/0001/01/a18fa132d2853aa1636bbd61ccc017bc97f02187.png" height="2px" 	style="margin-top: 60px;">	</div>

<h3 id="h_etat" class="theme_d"  style="background: url('https://granddebat.fr/media/default/0001/01/7f02b283ff93bcd2b0016319e3ba3774f620b114.png') center center no-repeat;">Organisation de l’Etat et des services publics</h3>
<div class="row_white" >
		<div style="text-align: center;"></div> <!-- Empty to center the next one -->
		<div>
					<div>
						<label>Questions</label>
						<select id="select_chart_etat"></select>
					</div>
	
		</div>
	</div>
<div id="main_chart_etat" class="main_q">
	<div id="chart_etat" class="chart_m"></div>
</div>
<div id="main_chart_q_etat" class="main">
	<div class="row_white">
	  <div style="text-align: center;"></div> 
	  <div>
						<label >Réponses</label>
						<select id="select_resp_etat"></select>
						</div>
		</div>
			<div style="background-color: #fff; padding-bottom:150px;  padding-top:20px;">
	  <div id="chart_q_etat" class="chart"></div>
	  <div id="map_chart_etat" class="map"></div>
	</div>

</div>
	<div style="margin: 0 auto; width:100px; height:100px;">
	  		<img alt="" class="separator" src="https://granddebat.fr/media/default/0001/01/a18fa132d2853aa1636bbd61ccc017bc97f02187.png" height="2px" 	style="margin-top: 60px;">	  	
	</div>
<p class="footer" style="padding-top: 150px;" > Sources : Données ouvertes du GDN, Base de données infra communales (INSEE), Base Filosofi (INSEE), Calculs des auteurs <br>
*Les communes sont regroupées par code postal.</p>
<p class="footer" > Authors : <a href="https://twitter.com/LouisVlln">LouisVlln</a> - <a href="https://twitter.com/PA_veillon">PA_veillon</a> </p>
<p class="footer" > Contact : louis.veillon@gadz.org - paul-armand.veillon@polytechnique.org </p>

<link rel="stylesheet" href="color_panel.css">
<link rel="stylesheet" href="https://fonts.gstatic.com/s/montserrat/v12/JTURjIg1_i6t8kCHKm45_c5H3gnD_g.woff2">
<style>




.theme_1 {
    padding: 30px;
    margin: 0 auto;
    margin-bottom:0px;
    background-size: cover;
    color: white;
    font-weight: 400;
    font-size: 20px;
    display:flex;
    align-items:center;
    justify-content:center;
    font-family: 'Montserrat', sans-serif;
    background: url('https://granddebat.fr/media/default/0001/01/fdf81e0ca2c782599ebd3f9eeb802018bde5b845.jpeg') center center no-repeat;"
}

.theme_d {
    margin: 0 auto;
    margin-top: 100px;
    margin-bottom:20px;
    height: 100px;
    width: 100%;
    border-radius: 2% / 2%;
    background-size:auto;
    color: white;
    font-weight: 800;
    font-size: 20px;
    display:flex;
    align-items:center;
    justify-content:center;
    font-family: 'Montserrat', sans-serif;
}
.row_white {
  background-color:#154463;
  height:40px;
  color: white;
  width:100;
  font-family: 'Montserrat', sans-serif;
  padding-top:20px;
  padding-left:20px;
}

body {
  background-color:  #F6F6F6;
  width:100%;
}
#info {
	margin-top: 50px;
}

#deptinfo {
	margin-top: 30px;
}

.department {
	cursor: pointer;
	stroke: black;
	stroke-width: .5px;
}

.department:hover {
	stroke-width: 2px;
}

.button {
  background-color: #999999;
  border: none;
  color: white;
  padding: 10px 5px;
  text-align: center;
  text-decoration: none;
  display: inline-block;
  font-size: 11px;
  margin: 4px 2px;
  cursor: pointer;
  float: right;
}

.button1 {
  background-color: #e7e7e7;
  color: black;
  border: none;
  padding: 10px 9.3px;
  text-align: center;
  text-decoration: none;
  display: inline-block;
  font-size: 11px;
  margin: 4px 2px;
  cursor: pointer;
  float: right;
}

.button1:hover {
  background-color: #c6c6c6; 
  color: white;
}

.button:hover {
  background-color: #c6c6c6; 
  color: white;
}

div.tooltip {
	position: absolute;
	opacity:0.8;
	z-index:1000;
	text-align:left;
	border-radius:4px;
	-moz-border-radius:4px;
	-webkit-border-radius:4px;
	padding:8px;
	color:#fff;
	background-color:#000;
	font: 12px sans-serif;
	max-width: 300px;
	height: 40px;
}

div.tooltip_c {
	position: absolute;
	opacity:0.8;
	z-index:1000;
	text-align:left;
	border-radius:4px;
	-moz-border-radius:4px;
	-webkit-border-radius:4px;
	padding:8px;
	color:#fff;
	background-color:#000;
	font: 12px sans-serif;
	max-width: 300px;
	height: 40px;
}

div.tooltip_n {
	position: absolute;
	opacity:0.8;
	z-index:1000;
	text-align:left;
	border-radius:4px;
	-moz-border-radius:4px;
	-webkit-border-radius:4px;
	padding:8px;
	color:#fff;
	background-color:#000;
	font: 12px sans-serif;
	max-width: 300px;
	height: 40px;
}

div.tooltip_mc {
	position: absolute;
	opacity:0.8;
	z-index:1000;
	text-align:left;
	border-radius:4px;
	-moz-border-radius:4px;
	-webkit-border-radius:4px;
	padding:8px;
	color:#fff;
	background-color:#000;
	font: 12px sans-serif;
	max-width: 300px;
	height: 40px;
}

#svg {
	display: block;
	margin: auto;
}

#svgn {
	display: block;
	margin: auto;
}

.row {
	width: 100%;
}

.svgc {
	display: block;
	margin: auto;
}

.svgm {
	display: block;
	float: left;
	margin: auto;
}


.footer {
	text-align: center;
	font-weight: 300;
	font-size:0.8em;
	font-style: italic;
}

.main {
    width: 100%;
    height: 600px;
    margin: 0 auto;
    font-family: 'Montserrat', sans-serif;
   
}

.main_q {
    width: 100%;
    height: 500px;
    margin: 0 auto;
   
}



.chart_m {
	width:100%;
	height: 500px;
	margin: 0 auto;
        
}
.chart {
	width: 50%;
	height: 500px;
	float: left;
}

.map{
    width: 50%;
    height: 500px;
    margin-left:50%;

}

</style>
<body>
<script src="https://d3js.org/d3.v5.min.js"></script>
<script src="https://d3js.org/topojson.v2.min.js"></script>
<script src="https://d3js.org/queue.v1.min.js"></script>
<script>
const width = 600, height = 550;

// Create a path object to manipulate geo data
const path = d3.geoPath();

// Define projection property
const projection = d3.geoConicConformal() // Lambert-93
	.center([2.454071, 46.279229]) // Center on France
	.scale(2600)
	.translate([width / 2 - 50, height / 2]);

path.projection(projection); // Assign projection to path object


var promises = [];
promises.push(d3.json('france.json'));

var dic_color = {};

dic_color["perc_fisc"]="Reds";
dic_color["perc_ecolo"]="Greens";
dic_color["perc_cit"]="YlOrBr";
dic_color["perc_etat"]="PuBu";
dic_color["perc_part"]="Blues"



//---------------------------------------

/*
const svgn = d3.select('#network').append("svg")
	.attr("id", "svgn")
	.attr("width", width)
	.attr("height", height+50);

	
var data_selected_n = "ecolo";

var promises_n = [];
promises_n.push(d3.csv("embeddings_"+data_selected_n+".csv"));


function plot_n(values) {
	var width_ = +svgn.attr("width");
	var height_ = +svgn.attr("height");
	const divn = d3.select("body").append("div")
    		.attr("class", "tooltip_n")         
    		.style("opacity", 0);
	
	const csv = values[0];
	var linear_x= d3.scaleLinear()
		.domain([d3.min(csv, function(e) { return +e["0"]; }), d3.max(csv, function(e) { return +e["0"]; })])
		.range([0,width]);
	var linear_y= d3.scaleLinear()
		.domain([d3.min(csv, function(e) { return +e["1"]; }), d3.max(csv, function(e) { return +e["1"]; })])
		.range([0,height]);
	var linear_r= d3.scaleLinear()
		.domain([d3.min(csv, function(e) { return +e["degree"]; }), d3.max(csv, function(e) { return +e["degree"]; })])
		.range([0.7,12]);
	var features = svgn
		.selectAll("circle")
		.data(csv)
		.enter()
		.append("circle")
		.attr('cx', width/2)
		.attr("cy", height/2)
   		.attr("r", function(d) {return linear_r(d["degree"]);})
		.style("opacity", .8)
		.style("fill","#8bb1ef")
		.on("mouseover", function(d) {
				divn.transition()        
					.duration(200)      
					.style("opacity", .9);
				divn.html(d["word"])
					.style("left", (d3.event.pageX + 30) + "px")     
					.style("top", (d3.event.pageY - 30) + "px")
					.style("height","15px");
			})
		.on("mouseout", function(d) {
				div.style("opacity", 0);
				div.html("")
					.style("left", "-500px")
					.style("top", "-500px");
			});	
	
		
	
	features.transition()
			.duration(6000)
			.attr('cx', function(d) {return linear_x(d["0"]);})
			.attr("cy", function(d) {return linear_y(d["1"]);});
			
			
};

Promise.all(promises_n).then(plot_n);

d3.select("#select_network").on("change", function() {
	
	svgn.selectAll("*").remove();
	d3.selectAll("#svgn").attr("class", dic_color["perc_"+this.value]);
	promises_n.pop(d3.csv("embeddings_"+data_selected_n+".csv"));
	data_selected_n = this.value;
	promises_n.push(d3.csv("embeddings_"+data_selected_n+".csv"));
	Promise.all(promises_n).then(plot_n);


});	
	

		
*/


//--------------------------------------------------------------------------------

const margin_c = {top: 70, right: 20, bottom: 250, left: 120},
    width_c = 600 - margin_c.left - margin_c.right,
    height_c = 600 - margin_c.top - margin_c.bottom;

const x = d3.scaleBand()
    .range([0, width_c])
    .padding(0.3);

const y = d3.scaleLinear()
    .range([height_c, 0]);




promises.push(d3.csv("bd_questions_1.csv"));
promises.push(d3.csv("DEP_conso_QF_particpation.csv"));
promises.push(d3.csv("INSEE_conso_QF_particpation.csv"));


function plot_map_chart(values) {

	const geojson = values[0];
	const csv = values[1];
	const csv_dep = values[2];
        const csv_chart = values[3];
	const theme = values[4];
	
	
	
	


	var title = d3.select("#map_chart_"+theme).append("h5")
				.attr("id","title_"+theme);
	

	csv_theme = csv.filter(function(d) {return d.theme ==d3.select("#h_"+theme).text();});

	const svgc = d3.select("#chart_"+theme).append("svg")
    		.attr("id", "svgc_"+theme)
                .attr("class","svgc")
    		.attr("width", width_c + margin_c.left + margin_c.right)
    		.attr("height", height_c + margin_c.top + margin_c.bottom)
    		.append("g")
    		.attr("transform", "translate(" + margin_c.left + "," + margin_c.top + ")")
		.attr("class",dic_color["perc_"+theme]);

	    var quest_id= d3.nest()
		.key(function(d) { return d.Id1; })
		//.value(function(d) { return d.question; })
		.entries(csv_theme);
	   
	    d3.select('#select_chart'+'_'+theme).selectAll('option')
		 	.data(quest_id)
			.enter()
			.append('option')
			.text(function(d) {return d.values[0].question;})
			.attr('value',function(d){return d.key;});

	if (theme == "part") {
	var csv_selected = csv_theme;
	data_selected_c = csv_selected[0]['CODE_DEPT'];
	
	title.html(data_selected_c)
	     .style("text-align","center");
	}
	else {
	

	var data_id_selected = d3.select('#select_chart_'+theme).node().value;
	var csv_selected = csv_theme.filter(function(d) {return d.Id1 ==data_id_selected;});
	data_selected_c = csv_selected[0]['CODE_DEPT'];
	
	title.html("% de réponses : "+data_selected_c)
	     .style("text-align","center");
	}
	
	const svgm_c = d3.select('#map_chart_'+theme).append("svg")
		.attr("id", "svgm_"+theme)
		.attr("width", 600)
		.attr("height", 500)
		.attr("class", dic_color["perc_"+theme]+" svgm");

	var features = svgm_c
		.selectAll("path")
		.data(geojson.features)
		.enter()
		.append("path")
		.attr('id', function(d) {return "d_"+theme+"_" + d.properties.CODE_DEPT;})
		.attr("d", path);

	


	var quantile_select = "% Ouvriers";
	d3.select('#select_resp'+'_'+theme).selectAll('option').remove();
	d3.select('#select_resp'+'_'+theme).selectAll('option')
	 	.data(csv_selected)
		.enter()
		.append('option')
		.text(function(d) {return d.CODE_DEPT;})
		.attr('value',function(d){return d.Id2;});
	// Quantile scales map an input domain to a discrete range, 0...max(population) to 1...9
	var quantile = d3.scaleQuantile()
		.domain([ parseFloat(d3.min(csv_dep, function(e) { return +e[d3.select("#select_resp_"+theme).node().value]; }))*100, parseFloat(d3.max(csv_dep, function(e) { return +e[d3.select("#select_resp_"+theme).node().value]; }))*100])
		.range(d3.range(9));

	var legend = svgm_c.append('g')
		.attr('transform', 'translate(525, 150)')
		.attr('id', 'legend');
		
	legend.selectAll('.colorbar')
		.data(d3.range(9))
	  .enter().append('svg:rect')
		.attr('y', function(d) { return d * 20 + 'px'; })
		.attr('height', '20px')
		.attr('width', '20px')
		.attr('x', '0px')
		.attr("class", function(d) { return "q" + d + "-9"; });
			
	var legendScale = d3.scaleLinear()
		.domain([parseFloat(d3.min(csv_dep, function(e) { return +e[d3.select("#select_resp_"+theme).node().value]; }))*100, parseFloat(d3.max(csv_dep, function(e) { return +e[d3.select("#select_resp_"+theme).node().value]; }))*100])
		.range([0, 9 * 20]);
		
	var legendAxis = svgm_c.append("g")
                .attr("id","legendt")
		.attr('transform', 'translate(550, 150)')
		.call(d3.axisRight(legendScale).ticks(6));

	
	
		
	csv_dep.forEach(function(e,i) {
		d3.select("#d_"+theme+"_" + e.CODE_DEPT)
			.attr("class", function(d) { return "department q" + quantile(+e[d3.select("#select_resp_"+theme).node().value]*100) + "-9"; })
			.on("mouseover", function(d) {
				div.transition()        
					.duration(200)      
					.style("opacity", .9);
				div.html("<b>Département : </b>" + e.CODE_DEPT + "<br>"
						+ "<b>Valeur : </b>" + Math.round(e[d3.select("#select_resp_"+theme).node().value]*10000)/100 + "<br>")
					.style("left", (d3.event.pageX + 30) + "px")     
					.style("top", (d3.event.pageY - 30) + "px");
			})
			.on("mouseout", function(d) {
				div.style("opacity", 0);
				div.html("")
					.style("left", "-500px")
					.style("top", "-500px");
			});
	});
	   
	    const divc = d3.select("body").append("div")
    		.attr("class", "tooltip_c")         
    		.style("opacity", 0);

            const divmc = d3.select("body").append("div")
    		.attr("class", "tooltip_mc")         
    		.style("opacity", 0);
	    
            
	    
	    
		
	
	    // Conversion des caractères en nombres
	    csv.forEach(function(d) {
		d.total = parseInt(d.total);
               
	    });

            
	    
	    // Mise en relation du scale avec les données de notre fichier
	    // Pour l'axe X, c'est la liste des pays
	    // Pour l'axe Y, c'est le max des populations
	    x.domain(csv_selected.map(function(d) { return d.CODE_DEPT; }));
	    y.domain([0, d3.max(csv_selected, function(d) { return d.total; })]);

	    
	    // Ajout de l'axe X au SVG
	    // Déplacement de l'axe horizontal et du futur texte (via la fonction translate) au bas du SVG
	    // Selection des noeuds text, positionnement puis rotation
	    svgc.append("g")
		.attr("transform", "translate(0," + height_c + ")")
		.call(d3.axisBottom(x).tickSize(0))
		.selectAll("text")	
		    .attr("dx", "-.8em")
		    .attr("y","8")
		    //.attr("dy", "-.15em")
		    .call(wrap, 100);
		
	    function wrap(text, width) {
		    text.each(function() {
			var text = d3.select(this),
			words = text.text().split(/\s+/).reverse(),
			word,
			line = [],
			lineNumber = 0,
			y = text.attr("y"),
			dy = parseFloat(text.attr("dy")),
			lineHeight = 1.3, // ems
			tspan = text.text(null).append("tspan").attr("x", function(d) { return d.children || d._children ? -10 : 10; }).attr("y", 				y).attr("dy", dy + "em");     
			while (word = words.pop()) {
			    line.push(word);
			    tspan.text(line.join(" "));
			    var textWidth = tspan.node().getComputedTextLength();
			    if (tspan.node().getComputedTextLength() > width) {
				line.pop();
				tspan.text(line.join(" "));
				line = [word];
				++lineNumber;
				tspan = text.append("tspan").attr("x", function(d) { return d.children || d._children ? -10 : 10; }).attr("y", 0).attr("dy", lineNumber * lineHeight + dy*2 + "em").text(word);
			    }
			}
		    });
		}
	    
	    // Ajout de l'axe Y au SVG avec 6 éléments de légende en utilisant la fonction ticks (sinon D3JS en place autant qu'il peut).
	    svgc.append("g")
		.call(d3.axisLeft(y).ticks(6));

	    
	    svgc.selectAll(".bar")
		.data(csv_selected)
	    .enter().append("rect")
		.attr("class", "bar")
		.attr("x", function(d) { return x(d.CODE_DEPT); })
		.attr("width", x.bandwidth())
		.attr("y", function(d) { return y(d.total/10); })
		.attr("height", function(d) { return height_c - y(d.total/10); })		
		.attr("class","q5-9")
		.style("opacity",.8)
		.on("mouseover", function(d) {
		    divc.transition()        
		        .duration(200)      
		        .style("opacity", .9);
		    divc.html("Nbr de réponses : " + d.total)
		        .style("left", (d3.event.pageX + 10) + "px")     
		        .style("top", (d3.event.pageY - 50) + "px")
			.style("height","15px");
		    
		    
			
		})
		.on("mouseout", function(d) {
		    divc.transition()
		        .duration(500)
		        .style("opacity", 0);
		})
		.transition()
    			.duration(2000)
    			.attr("y", function(d) { return y(d.total); })
    			.attr("height", function(d) { return height_c - y(d.total); });
		
		svgc.append("text")
            		.attr("text-anchor", "middle")  // this makes it easy to centre the text as the transform is applied to the anchor
            		.attr("transform", "translate(-70, 120)rotate(-90)")  // text is drawn off the screen top left, move down and out and rotate
            		.text("Nbr de contributions");

		function plot_quantile(quantile_s, resp) {

			const svgc_c = d3.select("#chart_q_"+theme).append("svg")
		    		.attr("id", "svgc_c"+theme)
				.attr("class","svgc_c")
		    		.attr("width", width_c + margin_c.left + margin_c.right)
		    		.attr("height", height_c + margin_c.top + margin_c.bottom)
		    		.append("g")
		    		.attr("transform", "translate(" + margin_c.left + "," + margin_c.top + ")")
				.attr("class",dic_color["perc_"+theme]);

			var csv_select_q = csv_chart.filter(function (d) { return d.label == quantile_s;});
	
			if (quantile_s =="Type d'agglomération") {
				var x1 = d3.scaleBand()
	    			.range([0, width_c])
	    			.padding(0.3)
				.domain(csv_select_q.map(function(d) { return d.label_q; }));
			
				svgc_c.append("g")
				.attr("transform", "translate(0," + height_c + ")")
				.call(d3.axisBottom(x1).tickSize(0))
				.selectAll("text")	
				    .style("text-anchor", "end")
				    .attr("dx", "-.8em")
				    .attr("dy", ".15em")
				    .attr("y", "0")
				    .attr("transform", "rotate(-65)");
				}
            		
			else 	{	
			var x1 = d3.scaleBand()
	    			.range([0, width_c])
	    			.padding(0.3)
				.domain(csv_select_q.map(function(d) { return d.quantile; }));
				svgc_c.append("g")
				.attr("transform", "translate(0," + height_c + ")")
				.call(d3.axisBottom(x1).tickSize(0))
				.selectAll("text")	
				    .style("text-anchor", "end")
				    //.attr("dx", "-.8em")
				    .attr("dy", ".95em")
				    .attr("y", "0")
            .attr("font-weight",  "bold")
				    .attr("transform", "rotate(-45)");
				 svgc_c.append("text")
            				.attr("text-anchor", "middle")  
            				.attr("transform", "translate(230, 380)")  
            				.text(quantile_s+" dans la commune");

				
			 }
			
	    			//.padding(0.3);
			var max_= d3.max(csv_select_q, function(d) { return d[resp]; });
			max_=parseFloat(max_)*100*1.1;
			var min_ =d3.min(csv_select_q, function(d) { return d[resp]; });
			min_=parseFloat(min_)*100*0.9;
		    	y.domain([min_,max_]);
			
		    
		    // Ajout de l'axe Y au SVG avec 6 éléments de légende en utilisant la fonction ticks (sinon D3JS en place autant qu'il peut).
		    	svgc_c.append("g")
				.call(d3.axisLeft(y).ticks(6));
			svgc_c.selectAll("circle")
				.data(csv_select_q)
				.enter()
				.append("circle")
				.attr('cx', function(d){return x1(d.quantile);})
				.attr("cy", function (d) {return y(min_*1.2);})
		   		.attr("r",5)
				.style("opacity", .8)
				.attr("class","q5-9")
				.transition()
    					.duration(2000)
    					.attr("cy", function(d) { return y(d[resp]*100); });
    					

			if (theme=="part") {
			svgc_c.append("text")
            			.attr("text-anchor", "middle")  // this makes it easy to centre the text as the transform is applied to the anchor
            			.attr("transform", "translate(-70, 120)rotate(-90)")  // text is drawn off the screen top left, move down and out and rotate
            			.text(d3.select("#select_resp_"+theme).node().selectedOptions[0].innerHTML)
				.style("font-size",.99-.004*d3.select("#select_resp_"+theme).node().selectedOptions[0].innerHTML.length+"em");
			}
			else {
			var selec_text = "réponses : "+d3.select("#select_resp_"+theme).node().selectedOptions[0].innerHTML;
			svgc_c.append("text")
            			.attr("text-anchor", "middle")  // this makes it easy to centre the text as the transform is applied to the anchor
            			.attr("transform", "translate(-70, 120)rotate(-90)")  // text is drawn off the screen top left, move down and out and rotate
            			.text("% de "+selec_text)
				.style("font-size",.3+(.6-.005*selec_text.length)+"em");
			
			}
		};

		
			
		d3.select('#select_resp_'+theme).on('change', function(){
				
				quantile.domain([ parseFloat(d3.min(csv_dep, function(e) { return +e[d3.select("#select_resp_"+theme).node().value]; }))*100, parseFloat(d3.max(csv_dep, function(e) { return +e[d3.select("#select_resp_"+theme).node().value]; }	))*100]);
				
		   		 csv_dep.forEach(function(e,i) {
					d3.select("#d_"+theme+"_" + e.CODE_DEPT)
						.attr("class", "department q" + quantile(+e[d3.select("#select_resp_"+theme).node().value]*100) + "-9")
						.on("mouseover", function(l) {
							divmc.transition()        
								.duration(200)      
								.style("opacity", .9);
							divmc.html("<b>Département : </b>" + e.CODE_DEPT + "<br>"
								+ "<b>Valeur : </b>" + Math.round(e[d3.select("#select_resp_"+theme).node().value]*10000)/100 + "<br>")
							.style("left", (d3.event.pageX + 30) + "px")     
							.style("top", (d3.event.pageY - 30) + "px");});
					
					
			});
		    
		    legendScale.domain([parseFloat(d3.min(csv_dep, function(e) { return +e[d3.select("#select_resp_"+theme).node().value]; }))*100,parseFloat(d3.max(csv_dep, function(e) { return +e[d3.select("#select_resp_"+theme).node().value]; }))*100]);
		    legendAxis.call(d3.axisRight(legendScale).ticks(6));
		    if (theme=="part") {
		   	 title.html(d3.select("#select_resp_"+theme).node().selectedOptions[0].innerHTML);
			}
		    else {
			title.html("% de réponses : "+d3.select("#select_resp_"+theme).node().selectedOptions[0].innerHTML);
			}
		    d3.select('#svgc_c'+theme).remove();
		    plot_quantile(quantile_select,d3.select("#select_resp_"+theme).node().value);
			});

		
		
	
		d3.select("#chart_q_"+theme).append("button")
			.attr("type","button")
			.attr("class","button "+dic_color["perc_"+theme]+" q3-7")
			.text("Revenu médian")
			.on("click", function() {
				quantile_select = "Revenu médian";
				d3.select('#svgc_c'+theme).remove();
				plot_quantile(quantile_select,d3.select('#select_resp_'+theme).node().value);
				
			});
		d3.select("#chart_q_"+theme).append("button")
			.attr("type","button")
			.attr("class","button")
			.text("Type d'agglomération")
			.on("click", function() {
				quantile_select = "Type d'agglomération";
				d3.select('#svgc_c'+theme).remove();
				plot_quantile(quantile_select,d3.select('#select_resp_'+theme).node().value);
				
			});
		d3.select("#chart_q_"+theme).append("button")
			.attr("type","button")
			.attr("class","button")
			.text("% Ouvriers")
			.on("click", function() {
				quantile_select = "% Ouvriers";
				d3.select('#svgc_c'+theme).remove();
				plot_quantile(quantile_select,d3.select('#select_resp_'+theme).node().value);
				
			});
		d3.select("#chart_q_"+theme).append("button")
			.attr("type","button")
			.attr("class","button")
			.text("% Employés")
			.on("click", function() {
				quantile_select = "% Employés";
				d3.select('#svgc_c'+theme).remove();
				plot_quantile(quantile_select,d3.select('#select_resp_'+theme).node().value);
				
			});
		d3.select("#chart_q_"+theme).append("button")
			.attr("type","button")
			.attr("class","button")
			.text("% Retraités")
			.on("click", function() {
				quantile_select = "% Retraités";
				d3.select('#svgc_c'+theme).remove();
				plot_quantile(quantile_select,d3.select('#select_resp_'+theme).node().value);
				
			});
		d3.select("#chart_q_"+theme).append("button")
			.attr("type","button")
			.attr("class","button")
			.text("% Cadre et prof. Int. Sup.")
			.on("click", function() {
				quantile_select = "% Cadre et prof. Int. Sup.";
				d3.select('#svgc_c'+theme).remove();
				plot_quantile(quantile_select,d3.select('#select_resp_'+theme).node().value);
				
			});
			
			d3.select("#chart_q_"+theme).append("button")
		.attr("type","button1")
			.attr("class","button1")
			.text("% Abstention")
			.on("click", function() {
				quantile_select = "% Abstention";
				d3.select('#svgc_c'+theme).remove();
				plot_quantile(quantile_select,d3.select('#select_resp_'+theme).node().value);
				
			});	
			
				d3.select("#chart_q_"+theme).append("button")
		.attr("type","button1")
			.attr("class","button1")
			.text("% François Fillon")
			.on("click", function() {
				quantile_select = "% Vote François Fillon";
				d3.select('#svgc_c'+theme).remove();
				plot_quantile(quantile_select,d3.select('#select_resp_'+theme).node().value);
				
			});		
		d3.select("#chart_q_"+theme).append("button")
		.attr("type","button1")
			.attr("class","button1")
			.text("% Marine Le Pen")
			.on("click", function() {
				quantile_select = "% Vote Marine Le Pen";
				d3.select('#svgc_c'+theme).remove();
				plot_quantile(quantile_select,d3.select('#select_resp_'+theme).node().value);
				
			});
			
			d3.select("#chart_q_"+theme).append("button")
		.attr("type","button1")
			.attr("class","button1")
			.text("% Emmanuel Macron")
			.on("click", function() {
				quantile_select = "% Vote Emmanuel Macron";
				d3.select('#svgc_c'+theme).remove();
				plot_quantile(quantile_select,d3.select('#select_resp_'+theme).node().value);
				
			});	
		d3.select("#chart_q_"+theme).append("button")
			.attr("type","button1")
			.attr("class","button1")
			.text("% Jean-Luc Mélenchon")
			.on("click", function() {
				quantile_select = "% Vote Jean-Luc Mélenchon";
				d3.select('#svgc_c'+theme).remove();
				plot_quantile(quantile_select,d3.select('#select_resp_'+theme).node().value);
				
			});	
			
		
		
		
		
		plot_quantile(quantile_select,d3.select("#select_resp_"+theme).node().value);
	
};

promises.push('part');
Promise.all(promises).then(plot_map_chart);
promises.pop('part');

promises.push('ecolo');
Promise.all(promises).then(plot_map_chart);
promises.pop('ecolo');
// Append a DIV for the tooltip
var div = d3.select("body").append("div")   
	.attr("class", "tooltip_n")               
	.style("opacity", 0);

d3.select("#select_chart_ecolo").on("change", function() {
	promises.push('ecolo');
	d3.select("#svgc_ecolo").remove();
	d3.select("#svgm_ecolo").remove();
	d3.select("#svgc_cecolo").remove();
	d3.select("#chart_q_ecolo").selectAll("*").remove();
	d3.select("#title_ecolo").remove();
	//d3.selectAll("#svgn").attr("class", dic_color["perc_"+this.value]);
	//data_id_selected = this.value.toString();
	Promise.all(promises).then(plot_map_chart);
	promises.pop('ecolo');


});



promises.push('fisc');
Promise.all(promises).then(plot_map_chart);
promises.pop('fisc');



d3.select("#select_chart_fisc").on("change", function() {
	promises.push('fisc');
	d3.select("#svgc_fisc").remove();
	d3.select("#svgm_fisc").remove();
	d3.select("#svgc_cfisc").remove();
	d3.select("#chart_q_fisc").selectAll("*").remove();
	d3.select("#title_fisc").remove();
	//d3.selectAll("#svgn").attr("class", dic_color["perc_"+this.value]);
	data_id_selected = this.value.toString();
	Promise.all(promises).then(plot_map_chart);
	promises.pop('fisc');


});	

promises.push('cit');
Promise.all(promises).then(plot_map_chart);
promises.pop('cit');



d3.select("#select_chart_cit").on("change", function() {
	promises.push('cit');
	d3.select("#svgc_cit").remove();
	d3.select("#svgm_cit").remove();
	d3.select("#svgc_ccit").remove();
	d3.select("#chart_q_cit").selectAll("*").remove();
	d3.select("#title_cit").remove();
	//d3.selectAll("#svgn").attr("class", dic_color["perc_"+this.value]);
	//data_id_selected = this.value.toString();
	Promise.all(promises).then(plot_map_chart);
	promises.pop('cit');


});	

promises.push('etat');
Promise.all(promises).then(plot_map_chart);
promises.pop('etat');



d3.select("#select_chart_etat").on("change", function() {
	promises.push('etat');
	d3.select("#svgc_etat").remove();
	d3.select("#svgm_etat").remove();
	d3.select("#svgc_cetat").remove();
	d3.select("#chart_q_etat").selectAll("*").remove();
	d3.select("#title_etat").remove();
	//d3.selectAll("#svgn").attr("class", dic_color["perc_"+this.value]);
	data_id_selected = this.value.toString();
	Promise.all(promises).then(plot_map_chart);
	promises.pop('etat');


});	



			
</script>
</body>

